{% extends 'base.html' %}

{% block navbar_right %}
<a href="{{ url_for('student_management') }}" class="w3-bar-item w3-button w3-right w3-round" style="background-color: #d48166; color: rgba(255, 255, 255, 0.747); white-space: nowrap; padding-left: 8px; padding-right: 8px;">RETURN</a>
{% endblock %}

{% block content %}
<div class="w3-row">
    <!-- Main Content -->
    <div class="w3-col m10 w3-padding" style="display: flex; flex-direction: column; align-items: flex-start; width: 100%;">
        <h4 class="w3-left" style="margin: 0; padding-left: 0;">ADD/UPDATE STUDENT</h4>
    </div>

        <div class="w3-row-padding" style="display: flex; flex-wrap: wrap;">
            <!-- Left Panel - Camera and Form -->
            <div class="w3-half" style="min-width: 300px; flex: 1;">
                <div class="w3-container w3-padding w3-card-4 w3-border">
                    <label class="w3-text-red"><b>CAMERA VIEWER</b></label>
                    <center>
                        <div id="mycamera" style="width:100%; max-width:320px; height:240px; border:1px solid #c0c0c0; margin: 20px 0;"></div>
                    </center>
                    
                    <p>
                        <label><b>IDNO</b></label>
                        <input type="text" id="idno" class="w3-input w3-border" placeholder="Enter ID Number" required>
                    </p>
                    <p>
                        <label><b>LASTNAME</b></label>
                        <input type="text" id="lastname" class="w3-input w3-border" placeholder="Enter Last Name" required>
                    </p>
                    <p>
                        <label><b>FIRSTNAME</b></label>
                        <input type="text" id="firstname" class="w3-input w3-border" placeholder="Enter First Name" required>
                    </p>
                    <p>
                        <label><b>COURSE</b></label>
                        <select id="course" class="w3-select w3-border" required>
                            <option value="">Select Course</option>
                            <option value="BSIT">INFORMATION TECHNOLOGY</option>
                            <option value="BSCS">COMPUTER SCIENCE</option>
                            <option value="BSCPE">COMPUTER ENGINEERING</option>
                            <option value="BSE">EDUCATION</option>
                        </select>
                    </p>
                    <p>
                        <label><b>LEVEL</b></label>
                        <select id="level" class="w3-select w3-border" required>
                            <option value="">Select Level</option>
                            <option value="1">FIRST YEAR</option>
                            <option value="2">SECOND YEAR</option>
                            <option value="3">THIRD YEAR</option>
                            <option value="4">FOURTH YEAR</option>
                        </select>
                    </p>
                    <p class="w3-center">
                        <button class="w3-button w3-cyan w3-round" onclick="takepicture()">SNAP</button>
                    </p>
                </div>
            </div>

            <!-- Right Panel - Preview and QR Code -->
            <div class="w3-half" style="min-width: 300px; flex: 1;">
                <div class="w3-container w3-padding w3-card-4 w3-border">
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
                        <!-- Picture and QR Code Row -->
                        <div style="display: flex; flex-wrap: wrap; justify-content: center; width: 100%; gap: 20px; align-items: flex-start;">
                            <!-- Picture on Left -->
                            <div style="flex: 1; min-width: 150px; max-width: 280px; text-align: center;">
                                <div id="mypicture" style="width:100%; max-width:280px; border:1px solid #c0c0c0; background-color: #f0f0f0; padding:0; box-sizing: border-box; display: flex; align-items: center; justify-content: center;"></div>
                            </div>

                            <!-- QR Code on Right -->
                            <div style="flex: 1; min-width: 150px; max-width: 200px; text-align: center;">
                                <div id="myqrcode" style="display: flex; justify-content: center; align-items: center;"></div>
                            </div>
                        </div>

                        <!-- Info Table Below (Centered) -->
                        <div style="width: 100%; max-width: 400px; overflow-x: auto;">
                            <table class="w3-table w3-bordered" style="width: 100%;">
                                <tr><td style="padding: 10px; font-weight: bold; width: 50%; text-align: center;">IDNO</td><td style="padding: 10px; text-align: center;" id="myidno">-</td></tr>
                                <tr><td style="padding: 10px; font-weight: bold; width: 50%; text-align: center;">LASTNAME</td><td style="padding: 10px; text-align: center;" id="mylastname">-</td></tr>
                                <tr><td style="padding: 10px; font-weight: bold; width: 50%; text-align: center;">FIRSTNAME</td><td style="padding: 10px; text-align: center;" id="myfirstname">-</td></tr>
                                <tr><td style="padding: 10px; font-weight: bold; width: 50%; text-align: center;">COURSE</td><td style="padding: 10px; text-align: center;" id="mycourse">-</td></tr>
                                <tr><td style="padding: 10px; font-weight: bold; width: 50%; text-align: center;">LEVEL</td><td style="padding: 10px; text-align: center;" id="mylevel">-</td></tr>
                            </table>
                        </div>
                    </div>

                    <br>
                    <center>
                        <button class="w3-button w3-indigo w3-round w3-margin-top" onclick="saveStudent()">SAVE</button>
                    </center>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/webcam.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/qrcode.min.js') }}"></script>
<script>
    let capturedPhotoData = null;
    let studentId = null;
    
    // Initialize camera when page loads
    window.addEventListener('load', function() {
        Webcam.set({
            width: 320,
            height: 240,
            image_format: 'jpeg',
            jpeg_quality: 90
        });
        Webcam.attach('#mycamera');
        
        // Check if editing an existing student
        const urlParams = new URLSearchParams(window.location.search);
        studentId = urlParams.get('id');
        if (studentId) {
            loadStudentData(studentId);
        }
    });

    function loadStudentData(id) {
        // Fetch student data from API
        fetch('/api/student/data?id=' + id)
            .then(response => response.json())
            .then(data => {
                if (data && data.student) {
                    const student = data.student;
                    
                    // Populate form fields
                    document.getElementById('idno').value = student.idno || '';
                    document.getElementById('lastname').value = student.lastname || '';
                    document.getElementById('firstname').value = student.firstname || '';
                    document.getElementById('course').value = student.course || '';
                    document.getElementById('level').value = student.level || '';
                    
                    // Update info table on right side
                    document.getElementById('myidno').textContent = student.idno || '-';
                    document.getElementById('mylastname').textContent = student.lastname || '-';
                    document.getElementById('myfirstname').textContent = student.firstname || '-';
                    document.getElementById('mycourse').textContent = student.course || '-';
                    document.getElementById('mylevel').textContent = student.level || '-';
                    
                    // Display existing photo if available
                    if (data.photo) {
                        const photoContainer = document.getElementById('mypicture');
                        const img = document.createElement('img');
                        img.src = 'data:image/jpeg;base64,' + data.photo;
                        img.style.width = '100%';
                        img.style.height = 'auto';
                        img.style.objectFit = 'scale-down';
                        img.style.display = 'block';
                        img.style.maxWidth = '100%';
                        photoContainer.innerHTML = '';
                        photoContainer.appendChild(img);
                    }
                    
                    // Generate QR code from student IDNO
                    generateQRCode(student.idno);
                }
            })
            .catch(error => {
                console.error('Error loading student data:', error);
            });
    }

    function generateQRCode(text) {
        document.getElementById('myqrcode').innerHTML = '';
        const qr = new QRCode(document.getElementById('myqrcode'), {
            text: text,
            width: 200,
            height: 200
        });
    }
    
    function saveQRCodeImage(idno) {
        // Get the QR code canvas and convert to image
        const qrCanvas = document.querySelector('#myqrcode canvas');
        if (qrCanvas) {
            const qrImageData = qrCanvas.toDataURL('image/png');
            
            // Send QR code to server
            fetch('/api/save-qrcode', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    qrcode_data: qrImageData,
                    idno: idno
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('QR code saved:', data.filename);
                } else {
                    console.error('Error saving QR code:', data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    }

    function takepicture() {
        Webcam.snap(function(data_uri) {
            // Store the captured photo
            capturedPhotoData = data_uri;
            
            // Display it in the preview area (no cropping)
            const photoContainer = document.getElementById('mypicture');
            const img = document.createElement('img');
            img.src = data_uri;
            img.style.width = '100%';
            img.style.height = 'auto';
            img.style.objectFit = 'scale-down';
            img.style.display = 'block';
            img.style.maxWidth = '100%';
            photoContainer.innerHTML = '';
            photoContainer.appendChild(img);
            
            // Update the info table display
            document.getElementById('myidno').textContent = document.getElementById('idno').value || '-';
            document.getElementById('mylastname').textContent = document.getElementById('lastname').value || '-';
            document.getElementById('myfirstname').textContent = document.getElementById('firstname').value || '-';
            document.getElementById('mycourse').textContent = document.getElementById('course').value || '-';
            document.getElementById('mylevel').textContent = document.getElementById('level').value || '-';
            
            // Generate QR Code from IDNO
            generateQRCode(document.getElementById('idno').value);
        });
    }

    function saveStudent() {
        // Get form values
        const idno = document.getElementById('idno').value;
        const lastname = document.getElementById('lastname').value;
        const firstname = document.getElementById('firstname').value;
        const course = document.getElementById('course').value;
        const level = document.getElementById('level').value;

        // Validate required fields
        if (!idno || !lastname || !firstname || !course || !level) {
            alert('Please fill all fields');
            return;
        }

        // If adding new student, require photo. If editing, photo is optional
        if (!studentId && !capturedPhotoData) {
            alert('Please capture a photo');
            return;
        }

        // Prepare form data
        const formData = new FormData();
        formData.append('idno', idno);
        formData.append('lastname', lastname);
        formData.append('firstname', firstname);
        formData.append('course', course);
        formData.append('level', level);
        
        // Only include photo if one was captured
        if (capturedPhotoData) {
            formData.append('photo', capturedPhotoData);
        }

        // If editing, include the student ID
        if (studentId) {
            formData.append('student_id', studentId);
        }

        // Send to server
        fetch('{{ url_for("add_student") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Save the QR code
                saveQRCodeImage(idno);
                
                // Now save the photo to static/images folder (only after successful student save)
                if (capturedPhotoData) {
                    fetch('/api/save-photo', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            photo_data: capturedPhotoData,
                            firstname: firstname,
                            lastname: lastname
                        })
                    })
                    .then(response => response.json())
                    .then(photoData => {
                        console.log('Photo saved:', photoData.filename);
                    })
                    .catch(error => {
                        console.error('Error saving photo:', error);
                    });
                }
                
                alert('Student saved successfully! ID: ' + data.id);
                // Redirect to student management
                window.location.href = '{{ url_for("student_management") }}';
            } else {
                alert('Error: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error saving student');
        });
    }
</script>
{% endblock %}
