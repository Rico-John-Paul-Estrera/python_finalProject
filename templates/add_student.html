{% extends 'base.html' %}

{% block navbar_right %}
<a href="{{ url_for('logout') }}" class="w3-bar-item w3-button w3-right">LOGOUT</a>
{% endblock %}

{% block content %}
<div class="w3-row">
    <!-- Sidebar -->
    <div class="w3-col m2" style="background-color: #00bcd4; min-height: 100vh; padding: 0;">
        <div class="w3-bar-block" style="padding: 10px 0;">
            <a href="{{ url_for('user_management') }}" class="w3-bar-item w3-button w3-text-white" style="text-align: left; padding: 15px;">USER MNGT</a>
            <a href="{{ url_for('student_management') }}" class="w3-bar-item w3-button w3-text-white" style="text-align: left; padding: 15px;">STUDENT MNGT</a>
            <a href="{{ url_for('view_attendance') }}" class="w3-bar-item w3-button w3-text-white" style="text-align: left; padding: 15px;">VIEW ATTENDANCE</a>
            <a href="{{ url_for('logout') }}" class="w3-bar-item w3-button w3-text-white" style="text-align: left; padding: 15px;">LOGOUT</a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="w3-col m10 w3-padding">
        <h3>ADD/UPDATE STUDENT</h3>
        
        <div class="w3-row-padding">
            <!-- Left Panel - Camera -->
            <div class="w3-half">
                <div class="w3-container w3-padding w3-card-4 w3-border">
                    <label class="w3-text-red"><b>CAMERA VIEWER</b></label>
                    <center>
                        <div id="mycamera" style="width:100%; max-width:320px; height:240px; border:1px solid #c0c0c0; margin: 20px 0;"></div>
                    </center>
                    
                    <p>
                        <label><b>IDNO</b></label>
                        <input type="text" id="idno" class="w3-input w3-border" placeholder="Enter ID Number" required>
                    </p>
                    <p>
                        <label><b>LASTNAME</b></label>
                        <input type="text" id="lastname" class="w3-input w3-border" placeholder="Enter Last Name" required>
                    </p>
                    <p>
                        <label><b>FIRSTNAME</b></label>
                        <input type="text" id="firstname" class="w3-input w3-border" placeholder="Enter First Name" required>
                    </p>
                    <p>
                        <label><b>COURSE</b></label>
                        <select id="course" class="w3-select w3-border" required>
                            <option value="">Select Course</option>
                            <option value="BSIT">INFORMATION TECHNOLOGY</option>
                            <option value="BSCS">COMPUTER SCIENCE</option>
                            <option value="BSCPE">COMPUTER ENGINEERING</option>
                            <option value="BSE">EDUCATION</option>
                        </select>
                    </p>
                    <p>
                        <label><b>LEVEL</b></label>
                        <select id="level" class="w3-select w3-border" required>
                            <option value="">Select Level</option>
                            <option value="1">FIRST YEAR</option>
                            <option value="2">SECOND YEAR</option>
                            <option value="3">THIRD YEAR</option>
                            <option value="4">FOURTH YEAR</option>
                        </select>
                    </p>
                    <p class="w3-center">
                        <button class="w3-button w3-blue w3-round" onclick="takepicture()">SNAP</button>
                    </p>
                </div>
            </div>

            <!-- Right Panel - Preview -->
            <div class="w3-half">
                <div class="w3-container w3-padding w3-card-4 w3-border">
                    <center>
                        <div id="mypicture" style="width:100%; max-width:320px; height:240px; border:1px solid #c0c0c0; margin: 20px 0; background-color: #f0f0f0;"></div>
                    </center>

                    <table class="w3-table w3-bordered w3-margin-top">
                        <tr><th>IDNO</th><td id="myidno">-</td></tr>
                        <tr><th>LASTNAME</th><td id="mylastname">-</td></tr>
                        <tr><th>FIRSTNAME</th><td id="myfirstname">-</td></tr>
                        <tr><th>COURSE</th><td id="mycourse">-</td></tr>
                        <tr><th>LEVEL</th><td id="mylevel">-</td></tr>
                    </table>

                    <br>
                    <center>
                        <div id="myqrcode" style="margin: 20px 0;"></div>
                    </center>

                    <center>
                        <button class="w3-button w3-cyan w3-round w3-margin-top" onclick="saveStudent()">SAVE</button>
                    </center>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/webcam.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/qrcode.min.js') }}"></script>
<script>
    Webcam.set({
        width: 320,
        height: 240,
        image_format: 'jpeg',
        jpeg_quality: 90,
    });
    Webcam.attach("#mycamera");

    function takepicture() {
        Webcam.snap(function(data_uri) {
            document.getElementById('mypicture').innerHTML = '<img id="imageprev" src="' + data_uri + '" style="width:100%; height:100%; object-fit:cover;"/>';
            document.getElementById('myidno').innerHTML = document.getElementById('idno').value || '-';
            document.getElementById('mylastname').innerHTML = document.getElementById('lastname').value || '-';
            document.getElementById('myfirstname').innerHTML = document.getElementById('firstname').value || '-';
            document.getElementById('mycourse').innerHTML = document.getElementById('course').value || '-';
            document.getElementById('mylevel').innerHTML = document.getElementById('level').value || '-';

            // Generate QR Code
            var myqrcode = document.getElementById('myqrcode');
            myqrcode.innerHTML = ''; // Clear previous QR code
            var qr = new QRCode(myqrcode, {
                text: document.getElementById('idno').value,
                width: 128,
                height: 128,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        });
    }

    function saveStudent() {
        var idno = document.getElementById('idno').value;
        var lastname = document.getElementById('lastname').value;
        var firstname = document.getElementById('firstname').value;
        var course = document.getElementById('course').value;
        var level = document.getElementById('level').value;

        if (!idno || !lastname || !firstname || !course || !level) {
            alert('Please fill in all fields');
            return;
        }

        var formData = new FormData();
        formData.append('idno', idno);
        formData.append('lastname', lastname);
        formData.append('firstname', firstname);
        formData.append('course', course);
        formData.append('level', level);

        fetch('{{ url_for("save_student") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                alert('Student saved successfully!');
                window.location.href = '{{ url_for("student_management") }}';
            } else {
                alert('Error saving student');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error saving student');
        });
    }
</script>
{% endblock %}
